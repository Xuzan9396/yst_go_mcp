name: Release YST Go MCP

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  # macOS arm64 ç¼–è¯‘ä»»åŠ¡ï¼ˆApple Siliconï¼‰
  build-macos-arm64:
    name: Build macOS ARM64
    runs-on: macos-latest  # macos-latest æ˜¯ arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0'

      - name: Build
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Building for macOS arm64 - Version: $VERSION"

          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o yst-go-mcp ./cmd/yst-go-mcp

          # é‡å‘½å
          mv yst-go-mcp yst-go-mcp-darwin-arm64

          # éªŒè¯
          file yst-go-mcp-darwin-arm64
          ls -lh yst-go-mcp-darwin-arm64

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yst-go-mcp-darwin-arm64
          path: yst-go-mcp-darwin-arm64

  # macOS amd64 ç¼–è¯‘ä»»åŠ¡ï¼ˆIntelï¼‰
  build-macos-amd64:
    name: Build macOS AMD64
    runs-on: macos-13  # macos-13 æ˜¯ x86_64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0'

      - name: Build
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Building for macOS amd64 - Version: $VERSION"

          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o yst-go-mcp ./cmd/yst-go-mcp

          # é‡å‘½å
          mv yst-go-mcp yst-go-mcp-darwin-amd64

          # éªŒè¯
          file yst-go-mcp-darwin-amd64
          ls -lh yst-go-mcp-darwin-amd64

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yst-go-mcp-darwin-amd64
          path: yst-go-mcp-darwin-amd64

  # Linux ç¼–è¯‘ä»»åŠ¡ï¼ˆamd64ï¼‰
  build-linux-amd64:
    name: Build Linux AMD64
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0'

      - name: Build
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Building for Linux amd64 - Version: $VERSION"

          GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o yst-go-mcp ./cmd/yst-go-mcp

          # é‡å‘½å
          mv yst-go-mcp yst-go-mcp-linux-amd64

          # éªŒè¯
          file yst-go-mcp-linux-amd64
          ls -lh yst-go-mcp-linux-amd64

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yst-go-mcp-linux-amd64
          path: yst-go-mcp-linux-amd64

  # Windows ç¼–è¯‘ä»»åŠ¡ï¼ˆamd64ï¼‰
  build-windows-amd64:
    name: Build Windows AMD64
    runs-on: ubuntu-latest  # äº¤å‰ç¼–è¯‘
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0'

      - name: Build
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Building for Windows amd64 - Version: $VERSION"

          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o yst-go-mcp.exe ./cmd/yst-go-mcp

          # é‡å‘½å
          mv yst-go-mcp.exe yst-go-mcp-windows-amd64.exe

          # éªŒè¯
          file yst-go-mcp-windows-amd64.exe
          ls -lh yst-go-mcp-windows-amd64.exe

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yst-go-mcp-windows-amd64
          path: yst-go-mcp-windows-amd64.exe

  # Windows ç¼–è¯‘ä»»åŠ¡ï¼ˆarm64ï¼‰
  build-windows-arm64:
    name: Build Windows ARM64
    runs-on: ubuntu-latest  # äº¤å‰ç¼–è¯‘
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.0'

      - name: Build
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Building for Windows arm64 - Version: $VERSION"

          GOOS=windows GOARCH=arm64 go build -ldflags="-s -w" -o yst-go-mcp.exe ./cmd/yst-go-mcp

          # é‡å‘½å
          mv yst-go-mcp.exe yst-go-mcp-windows-arm64.exe

          # éªŒè¯
          file yst-go-mcp-windows-arm64.exe
          ls -lh yst-go-mcp-windows-arm64.exe

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: yst-go-mcp-windows-arm64
          path: yst-go-mcp-windows-arm64.exe

  # åˆ›å»º GitHub Release å¹¶å‘å¸ƒåˆ° NPM
  create-release:
    name: Create Release and Publish NPM
    needs: [build-macos-arm64, build-macos-amd64, build-linux-amd64, build-windows-amd64, build-windows-arm64]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Display structure
        run: ls -R ./artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          cp artifacts/yst-go-mcp-darwin-arm64/yst-go-mcp-darwin-arm64 release/
          cp artifacts/yst-go-mcp-darwin-amd64/yst-go-mcp-darwin-amd64 release/
          cp artifacts/yst-go-mcp-linux-amd64/yst-go-mcp-linux-amd64 release/
          cp artifacts/yst-go-mcp-windows-amd64/yst-go-mcp-windows-amd64.exe release/
          cp artifacts/yst-go-mcp-windows-arm64/yst-go-mcp-windows-arm64.exe release/

          # è®¾ç½®æ‰§è¡Œæƒé™
          chmod +x release/yst-go-mcp-darwin-*
          chmod +x release/yst-go-mcp-linux-*

          ls -lh release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          body: |
            ## YST Go MCP - KPI æ—¥æŠ¥è‡ªåŠ¨é‡‡é›† MCP æœåŠ¡å™¨

            ### ğŸš€ å¿«é€Ÿå®‰è£…ï¼ˆæ¨èï¼‰

            **ä½¿ç”¨ npxï¼ˆæ— éœ€ Go ç¯å¢ƒï¼‰**:
            ```bash
            npx -y @xuzan/yst-go-mcp
            ```

            **é…ç½®åˆ° Claude Desktop**:
            ```json
            {
              "mcpServers": {
                "yst-go-mcp": {
                  "command": "npx",
                  "args": ["-y", "@xuzan/yst-go-mcp"]
                }
              }
            }
            ```

            ### ğŸ“¦ æ”¯æŒçš„å¹³å°

            æœ¬æ¬¡å‘å¸ƒåŒ…å«ä»¥ä¸‹å¹³å°çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼š

            **macOS**:
            - âœ… Apple Silicon (ARM64): `yst-go-mcp-darwin-arm64`
            - âœ… Intel (AMD64): `yst-go-mcp-darwin-amd64`

            **Linux**:
            - âœ… x64 (AMD64): `yst-go-mcp-linux-amd64`

            **Windows**:
            - âœ… x64 (AMD64): `yst-go-mcp-windows-amd64.exe`
            - âœ… ARM64: `yst-go-mcp-windows-arm64.exe`

            ### ğŸ”§ æ‰‹åŠ¨ä¸‹è½½å®‰è£…

            **macOS (Apple Silicon)**:
            ```bash
            curl -L https://github.com/Xuzan9396/yst_go_mcp/releases/latest/download/yst-go-mcp-darwin-arm64 -o yst-go-mcp
            chmod +x yst-go-mcp
            mv yst-go-mcp /usr/local/bin/
            ```

            **macOS (Intel)**:
            ```bash
            curl -L https://github.com/Xuzan9396/yst_go_mcp/releases/latest/download/yst-go-mcp-darwin-amd64 -o yst-go-mcp
            chmod +x yst-go-mcp
            mv yst-go-mcp /usr/local/bin/
            ```

            **Linux (amd64)**:
            ```bash
            curl -L https://github.com/Xuzan9396/yst_go_mcp/releases/latest/download/yst-go-mcp-linux-amd64 -o yst-go-mcp
            chmod +x yst-go-mcp
            sudo mv yst-go-mcp /usr/local/bin/
            ```

            **Windows (amd64)**:
            ä¸‹è½½ `yst-go-mcp-windows-amd64.exe` å¹¶æ”¾ç½®åˆ° PATH ç¯å¢ƒå˜é‡ç›®å½•ä¸­

            ### âœ¨ åŠŸèƒ½ç‰¹æ€§

            - âœ… **è‡ªåŠ¨ç™»å½•**: ä½¿ç”¨ chromedp è‡ªåŠ¨åŒ–æµè§ˆå™¨ç™»å½•
            - âœ… **æŒä¹…åŒ–ä¼šè¯**: ç™»å½•ä¸€æ¬¡é•¿æœŸæœ‰æ•ˆï¼Œä¼šè¯ä¿å­˜åœ¨ `~/.yst_go_mcp/`
            - âœ… **æ‰¹é‡é‡‡é›†**: æ”¯æŒä¸€æ¬¡æ€§é‡‡é›†å¤šä¸ªæœˆä»½çš„æ—¥æŠ¥æ•°æ®
            - âœ… **æ ¼å¼åŒ–è¾“å‡º**: è‡ªåŠ¨ç”Ÿæˆç»“æ„åŒ– Markdown æŠ¥å‘Š
            - âœ… **è·¨å¹³å°**: macOS / Linux / Windows å…¨å¹³å°æ”¯æŒ

            ### ğŸ“– ä½¿ç”¨è¯´æ˜

            åœ¨ Claude Desktop ä¸­ç›´æ¥å¯¹è¯ï¼š
            ```
            ä½¿ç”¨ yst-go-mcp é‡‡é›† 2025-01 åˆ° 2025-03 çš„æ—¥æŠ¥
            ```

            é¦–æ¬¡ä½¿ç”¨ä¼šè‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼Œå®Œæˆ Google ç™»å½•åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é‡‡é›†æ•°æ®ã€‚

            ### ğŸ“š å®Œæ•´æ–‡æ¡£

            æŸ¥çœ‹ [README.md](https://github.com/Xuzan9396/yst_go_mcp/blob/main/README.md) äº†è§£æ›´å¤šä¿¡æ¯ã€‚

            ### ğŸ› é—®é¢˜åé¦ˆ

            å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨ [GitHub Issues](https://github.com/Xuzan9396/yst_go_mcp/issues) ä¸­åé¦ˆã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Prepare NPM package
        run: |
          # å¤åˆ¶ npm ç›®å½•
          cp -r npm npm-package
          cd npm-package

          # åˆ›å»º bin ç›®å½•
          mkdir -p bin

          # è·å–ç‰ˆæœ¬å·ï¼ˆå»æ‰ v å‰ç¼€ï¼‰
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "NPM Version: $VERSION"

          # æ›´æ–° package.json ç‰ˆæœ¬
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json

          cat package.json

      - name: Publish to NPM
        run: |
          cd npm-package
          npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
