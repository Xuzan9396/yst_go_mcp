# YST Go MCP 测试套件

所有测试文件已整理到此目录。

## 测试文件列表

| 文件 | 功能 | 说明 |
|------|------|------|
| `TestClient.go` | 基础 MCP 客户端测试 | 测试连接、列出工具、调用简单工具 |
| `TestFull.go` | 完整功能测试 | 测试所有 3 个工具的调用 |
| `TestStdio.go` | STDIO 协议测试 | 原始 JSON-RPC 协议通信测试 |
| `TestBrowserLogin.go` | **浏览器登录测试** | **测试登录模块是否正常** |

## 运行测试

### 1. 基础测试（快速）

```bash
cd test_mcp

# 测试 MCP 连接
go run TestClient.go

# 测试完整功能
go run TestFull.go

# 测试 STDIO 协议
go run TestStdio.go
```

### 2. 浏览器登录测试（需要图形界面）

```bash
cd test_mcp

# 运行浏览器登录测试
go run TestBrowserLogin.go
```

**测试流程**：
1. 启动 MCP Server
2. 调用 `browser_login` 工具
3. 自动打开浏览器窗口
4. 手动完成 Google OAuth 登录
5. 自动保存 Cookie
6. 验证登录状态（尝试采集数据）

**预期输出**：
```
=== 测试浏览器登录模块 ===

连接到服务器: /path/to/yst-go-mcp

📡 初始化 MCP 连接...
✓ 连接成功：YST Go MCP v0.1.0

🌐 测试浏览器登录功能
============================================================

⚠️  注意事项：
  1. 此测试会打开浏览器窗口
  2. 需要手动完成 Google OAuth 登录
  3. 登录超时时间：300 秒（5分钟）
  4. 登录成功后会自动保存 Cookie

按 Enter 键开始测试（或 Ctrl+C 取消）...

🚀 调用 browser_login 工具...
提示：请在弹出的浏览器中完成登录操作

[浏览器会自动打开，等待登录...]

============================================================
📊 测试结果
============================================================
✅ 测试成功！
⏱  耗时: 45.2 秒

📄 返回内容:
   ✅ 登录成功！Cookie 已保存，现在可以使用 collect_reports 采集数据了

------------------------------------------------------------
🔍 验证 Cookie 保存状态
------------------------------------------------------------
✓ Cookie 文件存在: ~/.yst_go_mcp/data/cookies.json
  大小: 1234 字节
  修改时间: 2025-10-06 00:30:15

------------------------------------------------------------
🔍 验证登录状态（尝试采集数据）
------------------------------------------------------------
✅ 登录验证成功！可以正常采集数据
   ✓ 采集完成！共采集 1 个月份，5 条日报

============================================================
🎉 浏览器登录测试完成！
============================================================
```

## 测试前提条件

1. ✅ 已编译 `yst-go-mcp` 二进制文件
   ```bash
   cd ..
   go build -o yst-go-mcp ./cmd/yst-go-mcp
   ```

2. ✅ 系统已安装 Chrome 或 Chromium 浏览器

3. ✅ 网络可访问 `https://kpi.drojian.dev`

4. ✅ （仅登录测试）有图形界面环境

## 快速测试所有功能

```bash
# 1. 基础连接测试
go run TestClient.go

# 2. 浏览器登录测试（需要手动登录）
go run TestBrowserLogin.go

# 3. 验证 STDIO 协议
go run TestStdio.go
```

## 故障排查

### 问题 1: 服务器不存在
```
服务器不存在: /path/to/yst-go-mcp
```
**解决**：先编译服务器
```bash
cd ..
go build -o yst-go-mcp ./cmd/yst-go-mcp
```

### 问题 2: 浏览器启动失败
```
启动浏览器失败: ...
```
**解决**：检查系统是否安装 Chrome/Chromium

### 问题 3: 登录超时
```
登录超时（300 秒）
```
**解决**：
- 检查网络连接
- 在浏览器中手动完成登录
- 增加超时时间（修改 `timeout` 参数）

## 注意事项

- 🔒 **Cookie 文件包含敏感信息**，测试后请妥善保管
- 🌐 **浏览器测试需要图形界面**，SSH 环境无法运行
- ⏱️ **登录测试可能需要 1-2 分钟**，请耐心等待
- 🧹 测试完成后可运行 `clear_saved_cookies` 工具清理数据
